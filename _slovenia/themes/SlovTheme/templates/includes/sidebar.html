<div class="sidebar">
  <div class="logo">
    <span style="height: 100%; vertical-align: middle; display: inline-block;"></span><!--Helper span to vertically center image-->
    <img alt="Imperial College Caving Club Migovec Cave exploration logo" src="{{ SITEURL }}/assets/sidebariclogo.png">
  </div>
  <div style="overflow-y: auto; overflow-x: hidden; height: 100%; display: flex; flex-flow: column nowrap;">

  <hr class="hrsidebartop">

  <div class="sidebar-content-box">
    <div class="sidebar-item"><a href="{{ SITEURL }}/">Home</a></div>
    <div class="sidebar-item"><a href="{{ SITEURL }}/pages/surveyrepo.html">Survey Repository</a></div>
    <div class="sidebar-item"><a href="https://github.com/jarvist/migovecsurveydata">Github</a></div>
    <div class="sidebar-item"><a href="http://migovec.wordpress.com/">Migovec Blog</a></div>
  </div>

  <hr class="hrsidebar">

<div class="sidebar-content-box">
  <div class="sidebar-item" data-idouter="exped-outer" data-idinner="exped-inner"><a href="#" onclick="return false;">Expeditions</a></div>
  <div class="sidebar-outer collapsed" id="exped-outer">
  <div class="sidebar-inner" id="exped-inner">
  {% set expedname = {"2015":"Pivo Moz", "2014":"Skozi Zrcalo", "2013":"Z Miga na Kuk", "2012":"Sledi Vetra", "2011":"Izgubljeni Raj", "2010":"Vodna Sled", "2009":"Brezzvezdna NoÄ", "2008":"Votla Gora ", "2007":"Slovenia", "2006":"Slovenia Recce", "2005":"Slovenia", "2004":"Slovenia", "2003":"Slovenia", "2001":"Slovenia", "2000":"Slovenia"} %}
  {% set year = '' %}
  {% for article in articles %}
  {% if article.date.strftime('%Y')|int > 1999 and article.type == "expedition" %}
  {% if article.date.strftime('%Y') != year %}
  {% if year != '' %}</div></div>{% endif%}
  {% set year = article.date.strftime('%Y')  %}
  <div class="sidebar-sub-item" data-idouter="exped-sub-outer-{{ year }}" data-idinner="exped-sub-inner-{{ year }}" data-upidouter="exped-outer" data-upidinner="exped-inner"><a href="#" onclick="return false;">{{ expedname[year] }} {{ year }}</a></div>
  <div class="sidebar-outer collapsed" id="exped-sub-outer-{{ year }}">
  <div class="sidebar-inner" id="exped-sub-inner-{{ year }}">
  {% endif %}
      <div class="sidebar-sub-sub-item"><a href="{{ SITEURL }}/{{ article.url }}">{{ article.title }}</a></div>
      {% if article.photoarchive is defined %}<div class="sidebar-sub-sub-item"><a href="{{ BASEURL }}/{{ article.photoarchive }}">{{ year }} Photos</a></div>{% endif %}
      {% if article.sidebarlink is defined %}<div class="sidebar-sub-sub-item"><a href="{{ BASEURL }}/{{ article.sidebarlink }}">{{ article.sidebarlinktitle }}</a></div>{% endif %}
  {% endif %}
  {% endfor %}
  </div></div></div></div>

  <div class="sidebar-item" data-idouter="1999-outer" data-idinner="1999-inner"><a href="#" onclick="return false;">Early History </a></div>
  <div class="sidebar-outer collapsed" id="1999-outer">
  <div class="sidebar-inner" id="1999-inner">
    <div class="sidebar-sub-item"><a href="/caving/FILES/expedtions/slovenia/slovpre2000/slov_cookbook.pdf">Cookbook</a></div>
    <div class="sidebar-sub-item"><a href="/caving/FILES/expedtions/slovenia/slovpre2000/1998_scuz_diary.pdf">Scuz's 1998 Diary</a></div>
    <div class="sidebar-sub-item"><a href="/caving/FILES/expedtions/slovenia/slovpre2000/1998_slov_report.pdf">1998 Report</a></div>
    <div class="sidebar-sub-item"><a href="/caving/FILES/expedtions/slovenia/slovpre2000/1999_slov_report.pdf">1999 Report</a></div>
    <div class="sidebar-sub-item"><a href="/caving/FILES/expedtions/slovenia/slovpre2000/1997_slov_report.pdf">1997 Report</a></div>
  {% for article in articles %}
  {% if article.date.strftime('%Y')|int < 2000 and article.type == "expedition" %}
      <div class="sidebar-sub-item"><a href="{{ SITEURL }}/{{ article.url }}">{{ article.title }}</a></div>
  {% endif %}
  {% endfor %}
  </div></div>
</div>

<hr class="hrsidebar">

<div class="sidebar-content-box">
<div class="sidebar-item"><a href="{{ BASEURL }}">Main ICCC Site</a></div>
</div>

<div id="sidebar-fill" class="sidebar-content-box">
</div>

<div class="sidebar-content-box">
  <div class="sidebar-item"><a href="http://www.google.com/recaptcha/mailhide/d?k=01pKgPf4L76j23E4ymTAu8fw==&c=CoX_UvK7tWMqLjrzhcaEXTCP8fRKKSw-Cl1eAzdIcj4=">Email Us</a></div>
</div>
</div>
<script>
  $(window).load(function() {
    var sbsection_search = "sbsection=";
    var sbsubsection_search = "sbsubsection=";
    var sbsection;
    var sbsubsection;
    var ca = document.cookie.split(';');
    for(var i=0; i<ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1);
        if (c.indexOf(sbsection_search) != -1) sbsection = c.substring(sbsection_search.length,c.length);
        if (c.indexOf(sbsubsection_search) != -1) sbsubsection = c.substring(sbsubsection_search.length,c.length);
    }
    if (sbsection != null) {
      var outerelement = $('#' + sbsection + '-outer');
      outerelement.css({
        'max-height': ''
      });
      outerelement.removeClass("collapsed");
    }

    if (sbsubsection != null) {
      var outerelement = $('#' + sbsection + '-sub-outer-' + sbsubsection);
      outerelement.css({
        'max-height': ''
      });
      outerelement.removeClass("collapsed");
    }
    //document.cookie = 'sbsection=' + ';Path=/rcc/caving/;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
    //document.cookie = 'sbsubsection=' + ';Path=/rcc/caving/;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
  });

  $(function() {
    $('div.sidebar-item, div.sidebar-sub-item').click(function() {
      //Check if in sub-menu. If so then set max-height of outer menu to default so it expands nicely with the sub menu transition.
      if ($(this).data("upidouter") != null && $(this).data("upidinner")) {
        var outer = $(this).data("upidouter");
        var inner = $(this).data("upidinner");
        var outerelement = $('#' + outer);
        var innerelement = $('#' + inner);
        if (!outerelement.hasClass('collapsed')) {
          //var newheight = parseInt(outerelement.css('max-height'), 10) + height;
          outerelement.css({
            'max-height': ''
          });
        }
      }

      var outer = $(this).data("idouter");
      var inner = $(this).data("idinner");
      var outerelement = $('#' + outer);
      var innerelement = $('#' + inner);
      //$(outerelement).bind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd", function(){  if (!$(this).hasClass('collapsed')){ $(this).css({ 'max-height': $(innerelement).outerHeight() + 'px' }); } });

      //Ensure that outer element knows the inner height
      //Needed to undo the sub-menus attribute removal from above
      var height = innerelement.outerHeight();
      outerelement.css({
        'max-height': (parseInt(height)).toString() + 'px'
      });
      //If collapsing, set max-height to 0. Delay to allow transition to work because we only just set the max-height
      if (!outerelement.hasClass('collapsed')) {
        setTimeout(function() {
          outerelement.css({
            'max-height': '0px'
          });
        }, 50);
      }
      outerelement.toggleClass('collapsed');

      //Collapse all sub menus when a menu is collapsed
      //Delay ensures outer transition looks nice
      if (outerelement.hasClass('collapsed')) {
        setTimeout(function() {
          $(outerelement).find(".sidebar-outer").addClass('collapsed').css({
            'max-height': '0px'
          });
        }, 400);
      }

      /*Script to remember sidebar submenu state and reopen things when you move
      to a trip report*/
      /*check if in a submenu*/
      if ($(this).data("upidouter") != null && $(this).data("upidinner")) {
        /*if yes get the id of the drawer wrappers, find them, also extract the section
        and sub section from them*/
        var upouter = $(this).data("upidouter");
        var sbsection = upouter.replace("-outer", "");
        var outer = $(this).data("idouter");
        var sbsubsection = outer.replace(sbsection + "-sub-outer-", "");
        var upouterelement = $('#' + upouter);
        var outerelement = $('#' + outer);

        /*If you're openeing a section/subsecton record it with a cookie
        if closing, delete that cookie*/
        if (!upouterelement.hasClass('collapsed')) {
          document.cookie = 'sbsection=' + sbsection  + ';Path=/rcc/caving/;';
        }
        else {
          document.cookie = 'sbsection=' + sbsection  + ';Path=/rcc/caving/;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        }
        if (!outerelement.hasClass('collapsed')) {
          document.cookie = 'sbsubsection=' + sbsubsection  + ';Path=/rcc/caving/;';
        }
        else {
          document.cookie = 'sbsubsection=' + sbsubsection  + ';Path=/rcc/caving/;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        }
      }
      else {
        /*Same as above but if there's no subsection*/
        var outer = $(this).data("idouter");
        var sbsection = outer.replace("-outer", "");
        var outerelement = $('#' + outer);
        if (!outerelement.hasClass('collapsed')) {
          document.cookie = 'sbsection=' + sbsection  + ';Path=/rcc/caving/;';
        }
        else {
          document.cookie = 'sbsection=' + sbsection  + ';Path=/rcc/caving/;expires=Thu, 01 Jan 1970 00:00:01 GMT;';;
        }
      }

      //The scrollbar appearing can cause some elements to flow onto another line. This increses the size of the inner
      //and can oveflow out of the outer. This ensures that at the end of a menu openeing, overflowing elements
      //are adjusted.
      var outer = $(this).data("idouter");
      var outerelement = $('#' + outer);
      outerelement.one('webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend', function(e) {
        $(".sidebar-outer").each(function() {
          if ($(this).prop('scrollHeight') > $(this).height() && !($(this).hasClass("collapsed"))) {
            height  = $(this).children(".sidebar-inner").outerHeight()
            $(this).css({'max-height':height});
          }
        });
      });
    });
  });
</script>
</div>
